# chenxiaofeng
个人主页
订单敏感信息处理方案
更新时间：2021-07-14
一、OAID字段说明：
订单中消费者敏感信息是指消费者订单中的收件人信息。具体脱敏信息字段包含：收件人姓名、收件人手机号、收件人电话(固定号码)、收件人详细地址（不包含省市区）。为了确保商家订单履约正常运行，平台将新增收件人ID字段【简称OAID】。OAID是本次升级新增的核心字段。升级后可以通过OAID进行订单合单，电子面单生成打印，服务短信发送、必要场景的信息解密功能等。

升级使用脱敏的订单数据+OAID方案后，可确保订单履约的全链路作业顺畅不受影响，同时能确保消费者的敏感信息受到保护

二、方案概述：
1.开发者（软件服务商、自研商家）从淘宝开放平台API或订单推送服务中获取的订单消费者敏感信息（收件人姓名、收件人手机、收件人电话、地址等）均为脱敏数据，本地不允许存储明文消费者敏感数据。

2.开发者（软件服务商、自研商家）的相关系统页面只能展示平台脱敏后的信息，如需展示明文需通过平台解密方案获得，并且要做好明文数据查看权限的隔离。

3.涉及三方仓的发货履约场景，订单处理类应用（ERP、OMS等）与仓储物流类应用（WMS等）之间的数据通信，必须通过淘宝开放平台定义的奇门相关接口来实现。

4.OAID可用于菜鸟电子面单产品的生成和打印。

5.开发者（软件服务商、自研商家）向消费者发送服务短信，可使用OAID通过淘宝开放平台提供的密文发送服务短信接口来实现。

三、通用场景升级说明：
由于每个应用的功能范围存在差异，此章节仅提供整体性介绍和常见或关键改造点的改造建议，不同的功能改造点涉及到使用不同的接口，还需要开发者（软件服务商、自研商家）根据自身产品情况做具体的实施和落地。

整体数据推送链路：

![image](https://user-images.githubusercontent.com/52741017/126310479-f3fcc16c-43e2-4a5e-b53d-1985faf41ba6.png)

1.脱敏后订单数据查询：
平台提供订单推送服务、API等方式查询订单数据，升级后查询到的消费者敏感信息以脱敏+OAID的形式返回。

查询订单详情数据可通过调用taobao.trade.fullinfo.get接口实现。

查询待发货订单数据可通过调用taobao.trades.sold.get接口实现

2.订单脱敏数据展示：
通过平台订单推送服务与API接口获取到的数据都是OAID+脱敏的形式，并按照此样式展示在相关页面，不做不必要的解密，不做明文展示。

通过taobao.trades.sold.get接口的调整使用，完成应用订单列表页或待发货订单列表页，信息的脱敏展示。

通过对taobao.trades.sold.query接口的调整使用，完成针对退货无头件场景查询时的模糊搜索功能的数据脱敏展示，实现各端、页面、列表按姓名搜索订单数据脱敏展示，实现各端、页面、列表按手机号搜索订单数据的脱敏展示，目前该接口只用于退货无头件场景的使用，不可用于非此场景的模糊查询。

通过对taobao.trade.fullinfo.get接口的调整使用，完成各端、页面、列表查看订单详细信息时对收件人信息

展示平台脱敏的数据。

3.脱敏后订单发货场景：
通过订单推送、taobao.trade.fullinfo.get、taobao.trades.sold.get、taobao.trades.sold.increment.get获取OAID+脱敏订单信息，然后调用菜鸟电子面单相关接口：cainiao.waybill.ii.get获取电子面单号，最后调用淘宝物流发货接口：alibaba.ascp.logistics.offline.send、taobao.logistics.offline.send进行订单发货

4.脱敏后订单合单处理：
同一个消费者在同一店铺内的待发货订单中，OAID相同的可以直接合单，不同的可调用订单合单接口：taobao.top.oaid.merge进行判断。

5.退款场景根据手机号或姓名搜索订单
按手机号模糊搜索订单数据可通过调用taobao.trades.sold.query接口实现

按收件姓名模糊搜索订单数据可通过调用taobao.trades.sold.query接口实现

6.奇门数据传输脱敏：
主要实现订单处理类应用（ERP、OMS等)-》奇门-》仓储物流类应用（WMS等)三方数据的互通传递，需要保证数据在脱敏+OAID的形式下完成

订单处理类应用（ERP、OMS等)需要支持仓储物流类应用（WMS等)对特殊订单通过奇门解密接口：taobao.qimen.receiverinfo.query的反向解密需求。

7.电子面单：
电子面单的获取接口兼容脱敏数据的处理，当前未接入新方案的订单，需传入空的OAID，和明文的收件人信息。接入新方案的订单，需传入不为空的OAID和交易单号tid。新方案中OAID和tid必填。

8.短信功能：
通过taobao.jst.sms.oaid.message.send接口实现OAID短信通知功能，该接口仅可用来发送订单履约相关的短信，不得用于和该笔订单履约无关的场景。

如果要确认消息是否投递成功，要通过监听消息来确认。目前用到短信能力的开发者（软件服务商、自研商家）应该都可以通过module回执码，匹配监听的消息对应查询这笔的发送状态。如需了解整体的短息服务对接可参考：通信服务使用介绍

9.订单解密查看
敏感数据查看通过解密接口：taobao.top.oaid.decrypt实现，功能上涉及到的几个比较明确的场景是：订单列表页可对指定的某笔订单做解密、订单详情页可对某笔指定的订单详情数据的解密、打印普通快递单，可实现对订单进行解密。如上解密功能实现过程中注意数据的隔离保护，解密后的明文只对发起解密的账户可见，其它账户登录后对同一笔订单数据看到的必须还是脱敏信息，做到数据的安全隔离不泄露。
